<!DOCTYPE html>
<html data-theme="light">
<head>
    <!-- æ”¯æŒæ‰‹æœº -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- å¢åŠ ä¸€ä¸ªå›¾æ ‡ ğŸ¦-->
     
    <link rel="icon" href="https://em-content.zobj.net/source/google/263/lizard_1f98e.png">
    <title>LAN Clipboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
       
    </style>
</head>
<body>
    <div id="drop-zone" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 24px;">
            æ‹–æ”¾æ–‡ä»¶åˆ°è¿™é‡Œä¸Šä¼ 
        </div>
    </div>
    <button onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="icon-button" style=" position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
        <i class="fas fa-arrow-up"></i> 
    </button>
    <div class="input-form">
        <div class="input-container">
            <textarea id="input-text" name="text" placeholder="è¾“å…¥æ–°æ–‡æœ¬\é“¾æ¥\ç²˜è´´å›¾ç‰‡\æ–‡ä»¶\..." form="text-form"></textarea>
            <div class="button-group">
                <button onclick="processInput()" id="add-btn" type="submit" form="text-form" class="icon-button">
                    <i class="fas fa-plus"></i>
                </button>
                <script>
                    function processInput() {
                        const input = document.getElementById('input-text');
                        const text = input.value.trim();
                        if(text.match(/^https?:\/\/.+/)) {
                            input.value = `<a href="${text}" target="_blank">${text}</a>`;
                        }
                    }
                </script>
                <button type="button" onclick="pasteClipboard()" class="icon-button">
                    <i class="fas fa-clipboard"></i>
                </button>
                <button id="theme-toggle" onclick="toggleTheme()" class="icon-button">
                    <i class="fas fa-moon dark-icon"></i>
                </button>
                <!-- å¢åŠ ä¸€ä¸ªåˆ·æ–°æŒ‰é’® -->
                <button onclick="window.location.href='/'" class="icon-button">
                    <i class="fas fa-refresh"></i>
                </button>
                <button onclick="clearHistory()" class="icon-button">
                    <i class="fas fa-trash"></i>
                </button>
                <!-- add photo btn -->
                <button onclick="document.getElementById('file-input').click()" class="icon-button">
                    <i class="fas fa-image"></i>
                    <input type="file" id="file-input" style="display: none;" accept="image/*" multiple onchange="uploadImages(this.files); this.value='';">
                </button>
                <!-- add file upload btn -->
                <button onclick="document.getElementById('file-input2').click()" class="icon-button">
                    <i class="fas fa-file-upload"></i>
                    <input type="file" id="file-input2" style="display: none;" accept="*" multiple onchange="uploadFiles(this.files); this.value='';">
                </button>
            </div>
        </div>
        <form id="text-form" method="POST"></form>
    </div>
<div class="card">
{% for card in cards|reverse %}
    <div class="card-wrapper" >
        <div class="card-header">
            <button onclick="copyContent(this)" class="icon-button raw-button" title="å¤åˆ¶å†…å®¹" style="padding: 4px 8px; font-size: 12px;">
                <i class="fas fa-copy"></i>
            </button>
            <script>
                // åœ¨æ¯ä¸ªå¡ç‰‡æ¸²æŸ“åæ‰§è¡Œæ£€æŸ¥
                document.addEventListener('DOMContentLoaded', function() {
                    const cardWrappers = document.querySelectorAll('.card-wrapper');
                    cardWrappers.forEach(wrapper => {
                        const content = wrapper.querySelector('.card-content').innerHTML;
                        const hasImageOrFile = content.includes('<img') || content.includes('file-card');
                        const rawButton = wrapper.querySelector('.raw-button[title="æŸ¥çœ‹åŸå§‹å†…å®¹"]');
                        if (hasImageOrFile && rawButton) {
                            rawButton.style.display = 'none';
                        }
                    });
                });
            </script>
            <button onclick="showRawContent(this)" class="icon-button raw-button" title="æŸ¥çœ‹åŸå§‹å†…å®¹" style="padding: 4px 8px; font-size: 12px;">
                <i class="fas fa-code"></i>
            </button>
            <button onclick="deleteCard(this)" class="icon-button raw-button delete-button"  style="padding: 4px 8px; font-size: 12px;" title="åˆ é™¤">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        <pre class="card-content" style="text-align: left; align-self: flex-start;">
{{ card | safe }}
        </pre>
    </div>
{% endfor %}
</div>

    <script>
        //  é»˜è®¤è®¾ç½®é»‘è‰²æ¨¡å¼
        document.documentElement.setAttribute('data-theme', 'dark');
        // è‡ªåŠ¨ focus textarea
        document.getElementById('input-text').focus();

        

        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }
        
        // åŠ è½½ä¿å­˜çš„ä¸»é¢˜è®¾ç½®
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);

        function clearHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†…å®¹å—?')) {
                fetch('/clear', { method: 'POST' })
                // ç›´æ¥åœ¨å‰ç«¯æ¸…ç©º
                document.querySelector('.card').innerHTML = '';
            }
        }
        function pasteClipboard() {
            // è·å–å‰ªè´´æ¿å†…å®¹
            navigator.clipboard.readText()
                .then(text => {
                    // å°†å†…å®¹è®¾ç½®åˆ°è¾“å…¥æ¡†
                    document.getElementById('input-text').value = text;
                    // æäº¤è¡¨å•
                    document.getElementById('text-form').submit();
                })
                .catch(err => {
                    console.error('è¯»å–å‰ªè´´æ¿å¤±è´¥:', err);
                });
        }
        // submit on enter
        document.getElementById('input-text').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('text-form').submit();
            }
        });

        // ç›‘å¬ Ctrl+V äº‹ä»¶
        document.addEventListener('paste', async function(e) {
            const items = e.clipboardData.items;
            let files = [];
            let text = '';

            for (let item of items) {
                if (item.type.indexOf('image') !== -1) {
                    const file = item.getAsFile();
                    // ä¸ºç²˜è´´çš„å›¾ç‰‡ç”Ÿæˆéšæœºæ–‡ä»¶å
                    const randomStr = Math.random().toString(36).substring(2, 8);
                    const newFile = new File([file], `image_${randomStr}.png`, {
                        type: file.type,
                        lastModified: file.lastModified
                    });
                    files.push(newFile);
                } else if (item.kind === 'file') {
                    // å¤„ç†éå›¾ç‰‡æ–‡ä»¶
                    const file = item.getAsFile();
                    files.push(file);
                } else if (item.type === 'text/plain') {
                    item.getAsString((str) => {
                        text += str;
                    });
                }
            }

            if (files.length > 0) {
                // æ ¹æ®æ–‡ä»¶ç±»å‹é€‰æ‹©ä¸Šä¼ æ–¹å¼
                for (const file of files) {
                    if (file.type.startsWith('image/')) {
                        await uploadImage([file]);
                    } else {
                        await uploadFiles([file]);
                    }
                }
            }
            
            if (text) {
                const textarea = document.querySelector('textarea[name="text"]');
                textarea.value += (textarea.value ? '\n' : '') + text;
            }
        });

        // ç›‘å¬æ–‡ä»¶è¾“å…¥å˜åŒ–
        document.getElementById('file-input').addEventListener('change', async function(e) {
            if (e.target.files && e.target.files.length > 0) {
                await uploadImage(Array.from(e.target.files));
            }
        });

        // ä¸Šä¼ å›¾ç‰‡å‡½æ•°
        async function uploadImage(files) {
            // æ”¯æŒå•ä¸ªæ–‡ä»¶æˆ–æ–‡ä»¶æ•°ç»„   
            const fileArray = Array.isArray(files) ? files : [files];
            let uploadedContent = '';
            
            for(const file of fileArray) {
                const formData = new FormData();
                formData.append('image', file);
                
                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const imageUrl = await response.text();
                    if (imageUrl) {
                        const fileSize = formatFileSize(file.size);
                        const markdownImage = file.name.match(/\.(jpg|jpeg|png|gif|bmp|webp)$/i) ? 
                            `<div class="image-card">
                                <img src="${imageUrl}" alt="${file.name}" >
                                <div class="image-info">
                                    <i class="fas fa-image" style="margin-right: 4px;"></i>
                                    <span>${file.name} (${fileSize})</span>
                                </div>
                            </div>` :
                            `<div class="file-card">
                                <i class="fas fa-file" style="margin-right: 8px;"></i>
                                <a href="${imageUrl}">${file.name}</a>
                                <span class="file-info" style="margin-left: 8px;">(${fileSize})</span>
                            </div>`;
                        uploadedContent += (uploadedContent ? '\n' : '') + markdownImage;
                    }
                } catch (error) {
                    console.error('ä¸Šä¼ å‡ºé”™:', error);
                }
            }
            
            if(uploadedContent) {
                const textarea = document.querySelector('textarea[name="text"]');
                textarea.value += (textarea.value ? '\n' : '') + uploadedContent;
                // æ¨¡æ‹Ÿç‚¹å‡»å¢åŠ æŒ‰é’®
                document.querySelector('#add-btn').click();
            }
        }
        
        function showRawContent(button) {
            // è·å–æœ€è¿‘çš„ pre å…ƒç´ ä¸­çš„å†…å®¹
            const content = button.closest('.card-wrapper').querySelector('.card-content').innerHTML;
            
            // åˆ›å»ºæ–°çª—å£å¹¶è®¾ç½®å†…å®¹
            const rawWindow = window.open('', '_blank');
            rawWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Raw Content</title>
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <style>
                        body {
                            background-color: #1e1e1e;
                            color: #d4d4d4;
                            font-family: 'Consolas', 'Courier New', monospace;
                            padding: 20px;
                            margin: 0;
                        }
                        pre {
                            white-space: pre-wrap;
                            word-wrap: break-word;
                            margin: 0;
                        }
                    </style>
                </head>
                <body>
                    <pre>${content.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
                </body>
                </html>
            `);
            rawWindow.document.close();
        }

        async function copyContent(button) {
            const cardContent = button.closest('.card-wrapper').querySelector('.card-content');
            const img = cardContent.querySelector('img');
            
            try {
                if (img) {
                    // å¦‚æœæ˜¯å›¾ç‰‡,å¤åˆ¶å›¾ç‰‡
                    const response = await fetch(img.src);
                    const blob = await response.blob();
                    await navigator.clipboard.write([
                        new ClipboardItem({
                            [blob.type]: blob
                        })
                    ]);
                } else {
                    // å¦‚æœæ˜¯æ–‡æœ¬,trimåå¤åˆ¶
                    const content = cardContent.innerText.trim();
                    await navigator.clipboard.writeText(content);
                }
                
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                button.title = 'å·²å¤åˆ¶ï¼';
                button.style.backgroundColor = '#4CAF50';
                setTimeout(() => {
                    button.title = 'å¤åˆ¶å†…å®¹';
                    button.style.backgroundColor = '';
                }, 1000);
            } catch (err) {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                button.title = 'å¤åˆ¶å¤±è´¥';
                button.style.backgroundColor = '#f44336';
                setTimeout(() => {
                    button.title = 'å¤åˆ¶å†…å®¹';
                    button.style.backgroundColor = '';
                }, 1000);
            }
        }

        async function uploadFiles(files) {
            let uploadedContent = '';
            
            for(const file of files) {
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    const response = await fetch('/upload_file', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const fileUrl = await response.text();
                    if (fileUrl) {
                        // è·å–æ–‡ä»¶å›¾æ ‡
                        const fileIcon = getFileIcon(file.name);
                        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
                        const fileSize = formatFileSize(file.size);
                        // å»ºå¸¦å›¾æ ‡å’Œæ–‡ä»¶å¤§å°çš„é“¾æ¥
                        const fileLink = `<div class="file-card">
                            <i class="${fileIcon}" style="margin-right: 8px;"></i>
                            <a href="${fileUrl}" target="_blank">${file.name}</a>
                            <span class="file-info" style="margin-left: 8px;">(${fileSize})</span>
                        </div>`;
                        uploadedContent += (uploadedContent ? '\n' : '') + fileLink;
                    }
                } catch (error) {
                    console.error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥:', error);
                }
            }
            
            if(uploadedContent) {
                const textarea = document.querySelector('textarea[name="text"]');
                textarea.value += (textarea.value ? '\n' : '') + uploadedContent;
                document.querySelector('#add-btn').click();
            }
        }

        // æ·»åŠ è·å–æ–‡ä»¶å›¾æ ‡çš„å‡½æ•°
        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const iconMap = {
                // å›¾ç‰‡
                'jpg': 'fas fa-file-image',
                'jpeg': 'fas fa-file-image',
                'png': 'fas fa-file-image',
                'gif': 'fas fa-file-image',
                'webp': 'fas fa-file-image',
                // æ–‡æ¡£
                'pdf': 'fas fa-file-pdf',
                'doc': 'fas fa-file-word',
                'docx': 'fas fa-file-word',
                'xls': 'fas fa-file-excel',
                'xlsx': 'fas fa-file-excel',
                'ppt': 'fas fa-file-powerpoint',
                'pptx': 'fas fa-file-powerpoint',
                // å‹ç¼©æ–‡ä»¶
                'zip': 'fas fa-file-archive',
                'rar': 'fas fa-file-archive',
                '7z': 'fas fa-file-archive',
                // ä»£ç æ–‡ä»¶
                'js': 'fas fa-file-code',
                'css': 'fas fa-file-code',
                'html': 'fas fa-file-code',
                'py': 'fas fa-file-code',
                // æ–‡æœ¬
                'txt': 'fas fa-file-alt',
                'md': 'fas fa-file-alt',
                // éŸ³é¢‘
                'mp3': 'fas fa-file-audio',
                'wav': 'fas fa-file-audio',
                // è§†é¢‘
                'mp4': 'fas fa-file-video',
                'avi': 'fas fa-file-video',
                'mov': 'fas fa-file-video'
            };
            
            return iconMap[ext] || 'fas fa-file';
        }

        // æ·»åŠ æ–‡ä»¶å¤§å°æ ¼å¼åŒ–å‡½æ•°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        const dropZone = document.getElementById('drop-zone');

        // æ˜¾ç¤ºæ‹–æ‹½åŒºåŸŸ
        document.addEventListener('dragenter', function(e) {
            e.preventDefault();
            dropZone.style.display = 'block';
        });

        document.addEventListener('dragover', function(e) {
            e.preventDefault();
        });

        // å¤„ç†æ–‡ä»¶æ‹–æ”¾
        dropZone.addEventListener('drop', async function(e) {
            e.preventDefault();
            dropZone.style.display = 'none';
            
            const files = Array.from(e.dataTransfer.files);
            for (const file of files) {
                if (file.type.startsWith('image/')) {
                    await uploadImage([file]);
                } else {
                    await uploadFiles([file]);
                }
            }
        });

        // éšè—æ‹–æ‹½åŒºåŸŸ
        dropZone.addEventListener('dragleave', function(e) {
            if (e.target === dropZone) {
                dropZone.style.display = 'none';
            }
        });

        async function deleteCard(button) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
                return;
            }
            
            const cardWrapper = button.closest('.card-wrapper');
            const content = cardWrapper.querySelector('.card-content').innerHTML.trim();
            
            try {
                const response = await fetch('/delete_card', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: content
                    })
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    // ä» DOM ä¸­ç§»é™¤å¡ç‰‡
                    cardWrapper.remove();
                } else {
                    alert('åˆ é™¤å¤±è´¥ï¼š' + result.message);
                }
            } catch (error) {
                console.error('åˆ é™¤å‡ºé”™:', error);
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

    </script>
</body>
</html> 