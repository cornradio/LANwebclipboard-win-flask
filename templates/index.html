<!DOCTYPE html>
<html data-theme="light">
<head>
    <!-- ÊîØÊåÅÊâãÊú∫ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Â¢ûÂä†‰∏Ä‰∏™ÂõæÊ†á ü¶é-->
     
    <link rel="icon" href="https://em-content.zobj.net/source/google/263/lizard_1f98e.png">
    <title>Clipboard Text</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <button onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="icon-button" style=" position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
        <i class="fas fa-arrow-up"></i>
    </button>
    <div class="input-form">
        <div class="input-container">
            <textarea id="input-text" name="text" placeholder="ËæìÂÖ•Êñ∞ÊñáÊú¨..." form="text-form"></textarea>
            <div class="button-group">
                <button onclick="processInput()" id="add-btn" type="submit" form="text-form" class="icon-button">
                    <i class="fas fa-plus"></i>
                </button>
                <script>
                    function processInput() {
                        const input = document.getElementById('input-text');
                        const text = input.value.trim();
                        if(text.match(/^https?:\/\/.+/)) {
                            input.value = `<a href="${text}" target="_blank">${text}</a>`;
                        }
                    }
                </script>
                <!-- ËøôÈáåÂ¢ûÂä†‰∏Ä‰∏™ÊåâÈíÆ,Á≤òË¥¥Ââ™Ë¥¥ÊùøÁöÑ -->
                <!-- <button type="button" onclick="pasteClipboard()" class="icon-button">
                    <i class="fas fa-clipboard"></i>
                </button> -->
                <button id="theme-toggle" onclick="toggleTheme()" class="icon-button">
                    <i class="fas fa-moon dark-icon"></i>
                </button>
                <!-- Â¢ûÂä†‰∏Ä‰∏™Âà∑Êñ∞ÊåâÈíÆ -->
                <button onclick="window.location.href='/'" class="icon-button">
                    <i class="fas fa-refresh"></i>
                </button>
                <button onclick="clearHistory()" class="icon-button">
                    <i class="fas fa-trash"></i>
                </button>
                <!-- add photo btn -->
                <button onclick="document.getElementById('file-input').click()" class="icon-button">
                    <i class="fas fa-image"></i>
                    <input type="file" id="file-input" style="display: none;" accept="image/*" multiple onchange="uploadImages(this.files); this.value='';">
                </button>
            </div>
        </div>
        <form id="text-form" method="POST"></form>
    </div>
<div class="card">
{% for card in cards %}
    <div class="card-content" style="text-align: left; align-self: flex-start;">
    {{ card | safe }}
    </div>
{% endfor %}


</div>

    <script>
        //  ÈªòËÆ§ËÆæÁΩÆÈªëËâ≤Ê®°Âºè
        document.documentElement.setAttribute('data-theme', 'dark');
        // Ëá™Âä® focus textarea
        document.getElementById('input-text').focus();

        

        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }
        
        // Âä†ËΩΩ‰øùÂ≠òÁöÑ‰∏ªÈ¢òËÆæÁΩÆ
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);

        function clearHistory() {
            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÂÜÖÂÆπÂêó?')) {
                fetch('/clear', { method: 'POST' })
                // Áõ¥Êé•Âú®ÂâçÁ´ØÊ∏ÖÁ©∫
                document.querySelector('.card').innerHTML = '';
            }
        }
        function pasteClipboard() {
            navigator.clipboard.readText()
                .then(text => {
                    const form = document.getElementById('text-form');
                    form.innerHTML = `<input type="hidden" name="text" value="${text}">`;
                    document.getElementById('text-form').submit();
                })
                .catch(err => {
                    console.error('Êó†Ê≥ïËØªÂèñÂâ™Ë¥¥ÊùøÂÜÖÂÆπ: ', err);
                    alert('Êó†Ê≥ïËÆøÈóÆÂâ™Ë¥¥ÊùøÔºåËØ∑Á°Æ‰øùÂ∑≤Êéà‰∫àÊùÉÈôê');
                });
        }
        // submit on enter
        document.getElementById('input-text').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('text-form').submit();
            }
        });

        // ÁõëÂê¨ Ctrl+V ‰∫ã‰ª∂
        document.addEventListener('paste', async function(e) {
            const items = e.clipboardData.items;
            for (let item of items) {
                if (item.type.indexOf('image') !== -1) {
                    const file = item.getAsFile();
                    // ÁªôÊñá‰ª∂ÂêçÂä†‰∏äÈöèÊú∫ÂêéÁºÄ
                    const randomSuffix = Math.random().toString(36).substring(2, 8);
                    const newFile = new File([file], `${file.name.replace(/\.[^/.]+$/, '')}_${randomSuffix}${file.name.match(/\.[^/.]+$/)[0]}`, {
                        type: file.type
                    });
                    await uploadImage(newFile);
                }
            }
        });

        // ÁõëÂê¨Êñá‰ª∂ËæìÂÖ•ÂèòÂåñ
        document.getElementById('file-input').addEventListener('change', async function(e) {
            if (e.target.files && e.target.files.length > 0) {
                await uploadImage(Array.from(e.target.files));
            }
        });

        // ‰∏ä‰º†ÂõæÁâáÂáΩÊï∞
        async function uploadImage(files) {
            // ÊîØÊåÅÂçï‰∏™Êñá‰ª∂ÊàñÊñá‰ª∂Êï∞ÁªÑ   
            const fileArray = Array.isArray(files) ? files : [files];
            let uploadedContent = '';
            
            for(const file of fileArray) {
                const formData = new FormData();
                formData.append('image', file);
                
                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const imageUrl = await response.text();
                    if (imageUrl) {
                        const markdownImage = file.name.match(/\.(jpg|jpeg|png|gif|bmp|webp)$/i) ? 
                            `<img src="${imageUrl}" alt="${file.name}" >` :
                            `<a href="${imageUrl}">${file.name}</a>`;
                        uploadedContent += (uploadedContent ? '\n' : '') + markdownImage;
                    }
                } catch (error) {
                    console.error('‰∏ä‰º†Âá∫Èîô:', error);
                }
            }
            
            if(uploadedContent) {
                const textarea = document.querySelector('textarea[name="text"]');
                textarea.value += (textarea.value ? '\n' : '') + uploadedContent;
                // Ê®°ÊãüÁÇπÂáªÂ¢ûÂä†ÊåâÈíÆ
                document.querySelector('#add-btn').click();
            }
        }
        

    </script>
</body>
</html> 